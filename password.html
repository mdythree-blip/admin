<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ğŸ” å¯†ç æœ¬ Â· by LINF</title>
    <!-- Font Awesome 5 å›¾æ ‡åº“ (å…è´¹) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* æµ…è‰²æ¨¡å¼å˜é‡ */
        :root {
            --bg-body: #f4f7fb;
            --bg-vault: white;
            --bg-add-panel: #f9faff;
            --border-add-panel: #e6ecf3;
            --text-primary: #1a2639;
            --text-secondary: #1f2c40;
            --text-label: #4a5b73;
            --border-light: #eef2f6;
            --border-table: #e3eaf2;
            --th-bg: #f0f5fc;
            --th-text: #1e3a5f;
            --cell-hover: #f8fbfe;
            --input-bg: white;
            --input-border: #d0dbe8;
            --btn-primary-bg: #1e3a6b;
            --btn-primary-border: #163256;
            --btn-outline-bg: white;
            --btn-outline-border: #c9d4e2;
            --btn-outline-text: #2c3e5a;
            --stats-bg: #e2eaf3;
            --stats-text: #1f3a5f;
            --toast-bg: #1e2b3c;
            --toast-text: #f0f6ff;
            --icon-color: #4f658a;
            --icon-hover-bg: #e1e9f3;
            --dropdown-bg: white;
            --dropdown-item-hover: #f0f5fc;
        }

        /* æš—é»‘æ¨¡å¼å˜é‡ */
        body.dark-mode {
            --bg-body: #121826;
            --bg-vault: #1e2434;
            --bg-add-panel: #252e3f;
            --border-add-panel: #3a4556;
            --text-primary: #e0e7ff;
            --text-secondary: #cbd5e1;
            --text-label: #9aaec9;
            --border-light: #2d3748;
            --border-table: #2d3748;
            --th-bg: #2a3442;
            --th-text: #a0b8d4;
            --cell-hover: #2a3442;
            --input-bg: #2d3748;
            --input-border: #4a5568;
            --btn-primary-bg: #2b4f8e;
            --btn-primary-border: #1e3a6b;
            --btn-outline-bg: #2d3748;
            --btn-outline-border: #4a5568;
            --btn-outline-text: #cbd5e1;
            --stats-bg: #2d3748;
            --stats-text: #a0b8d4;
            --toast-bg: #2d3748;
            --toast-text: #e0e7ff;
            --icon-color: #a0b8d4;
            --icon-hover-bg: #3a4556;
            --dropdown-bg: #1e2434;
            --dropdown-item-hover: #2a3442;
        }

        body {
            font-family: 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
            background: var(--bg-body);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px;
            margin: 0;
            transition: background-color 0.3s ease;
        }

        .password-vault {
            max-width: 1300px;
            width: 100%;
            background: var(--bg-vault);
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08), 0 8px 20px rgba(0, 20, 40, 0.06);
            padding: 20px 18px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            letter-spacing: -0.3px;
            border-bottom: 2px solid var(--border-light);
            padding-bottom: 16px;
            flex-wrap: wrap;
            transition: color 0.3s ease, border-color 0.3s ease;
        }

        h1 i {
            color: #2b4f8e;
            font-size: 1.8rem;
        }

        .header-actions {
            margin-left: auto;
            display: flex;
            gap: 10px;
            align-items: center;
            position: relative;
        }

        /* èœå•æŒ‰é’®å’Œä¸‹æ‹‰èœå• */
        .menu-container {
            position: relative;
        }

        .menu-btn {
            background: transparent;
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            color: var(--icon-color);
            cursor: pointer;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.3s ease;
        }

        .menu-btn:hover {
            background: var(--icon-hover-bg);
        }

        .menu-btn i {
            transition: transform 0.3s ease;
        }

        .menu-btn.open i {
            transform: rotate(90deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 50px;
            right: 0;
            background: var(--dropdown-bg);
            border: 1px solid var(--border-table);
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            width: 180px;
            z-index: 100;
            opacity: 0;
            transform: translateY(-10px);
            visibility: hidden;
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
            overflow: hidden;
        }

        .dropdown-menu.show {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }

        .dropdown-item {
            padding: 14px 18px;
            color: var(--text-secondary);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background: var(--dropdown-item-hover);
        }

        .dropdown-item i {
            width: 20px;
            color: #2b4f8e;
        }

        .btn-add {
            background: #1e3a6b;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            border: 1px solid #163256;
            box-shadow: 0 4px 10px rgba(20, 40, 70, 0.2);
            white-space: nowrap;
        }

        .btn-add:hover {
            background: #15335c;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px -6px #102a4e;
        }

        .btn-add i {
            font-size: 1rem;
        }

        /* æ·»åŠ é¢æ¿ - ä½¿ç”¨å˜é‡æ”¯æŒæš—é»‘æ¨¡å¼ */
        .add-panel {
            background: var(--bg-add-panel);
            border-radius: 20px;
            padding: 20px 16px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-end;
            border: 1px solid var(--border-add-panel);
            transition: background-color 0.3s ease, border-color 0.3s ease, opacity 0.2s ease, transform 0.2s ease;
        }

        .add-panel.hidden {
            display: none;
        }

        .input-field {
            flex: 1 1 180px;
            min-width: 150px;
        }

        .input-field label {
            display: block;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            font-weight: 600;
            color: var(--text-label);
            margin-bottom: 4px;
            transition: color 0.3s ease;
        }

        .input-field input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--input-border);
            border-radius: 16px;
            font-size: 1rem;
            background: var(--input-bg);
            color: var(--text-secondary);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease, box-shadow 0.2s;
            outline: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        .input-field input:focus {
            border-color: #2b4f8e;
            box-shadow: 0 0 0 3px rgba(43, 79, 142, 0.15);
        }

        /* å¯†ç è¾“å…¥è¡Œç‰¹æ®Šå¤„ç†ï¼šå¢åŠ å†…è”æŒ‰é’® */
        .password-row {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .password-row .input-field {
            flex: 1;
            min-width: 0; /* é˜²æ­¢æº¢å‡º */
        }

        .btn-generate {
            background: var(--btn-outline-bg);
            border: 1px solid var(--btn-outline-border);
            width: 46px;
            height: 46px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--icon-color);
            cursor: pointer;
            font-size: 1.2rem;
            transition: background-color 0.2s, transform 0.2s;
            margin-bottom: 4px; /* ä¸è¾“å…¥æ¡†åº•éƒ¨å¯¹é½å¾®è°ƒ */
        }

        .btn-generate:hover {
            background: var(--icon-hover-bg);
            transform: scale(1.05);
        }

        .btn-primary {
            background: var(--btn-primary-bg);
            color: white;
            border: none;
            padding: 12px 22px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            border: 1px solid var(--btn-primary-border);
            box-shadow: 0 8px 16px -8px rgba(20, 40, 70, 0.3);
            white-space: nowrap;
        }

        .btn-primary:hover {
            background: #15335c;
            transform: translateY(-2px);
            box-shadow: 0 12px 20px -10px #102a4e;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 18px;
        }

        /* æœç´¢æ¡† - è°ƒæ•´ä¸º1:10æ¯”ä¾‹ï¼ˆå®½:é•¿ â‰ˆ 10:1ï¼‰ */
        .search-wrapper {
            flex: 1 1 250px;
            max-width: 400px;          /* å®½åº¦æœ€å¤§400px */
            height: 40px;              /* é«˜åº¦å›ºå®š40pxï¼Œæ¯”ä¾‹10:1 */
            display: flex;
            align-items: center;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 40px;       /* åœ†è§’é€‚åº”é«˜åº¦ */
            padding: 0 4px 0 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .search-wrapper i {
            color: #7b8ba0;
            font-size: 1rem;
        }

        .search-wrapper input {
            flex: 1;
            border: none;
            padding: 0 8px;           /* å–æ¶ˆå‚ç›´å†…è¾¹è·ï¼Œç”±é«˜åº¦æ§åˆ¶ */
            font-size: 0.95rem;
            background: transparent;
            outline: none;
            min-width: 120px;
            color: var(--text-secondary);
            transition: color 0.3s ease;
            height: 100%;              /* å……æ»¡çˆ¶å®¹å™¨é«˜åº¦ */
            line-height: normal;
        }

        .clear-search {
            background: transparent;
            border: none;
            width: 32px;               /* ç¨å¾®ç¼©å°ä»¥é€‚åº”é«˜åº¦ */
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6f7d95;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s, color 0.2s;
        }

        .clear-search:hover {
            background: var(--icon-hover-bg);
            color: var(--icon-color);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-outline {
            background: var(--btn-outline-bg);
            border: 1px solid var(--btn-outline-border);
            padding: 8px 16px;
            border-radius: 40px;
            font-weight: 500;
            color: var(--btn-outline-text);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            font-size: 0.9rem;
        }

        .btn-outline:hover {
            background: var(--cell-hover);
            border-color: #9bb0ca;
        }

        .stats-badge {
            background: var(--stats-bg);
            padding: 6px 14px;
            border-radius: 50px;
            font-size: 0.85rem;
            color: var(--stats-text);
            font-weight: 500;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* è¡¨æ ¼ */
        .table-responsive {
            overflow-x: visible;
            border-radius: 18px;
            border: 1px solid var(--border-table);
            background: var(--bg-vault);
            margin-top: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.02);
            width: 100%;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
            min-width: 0;
        }

        th {
            background: var(--th-bg);
            color: var(--th-text);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-table);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-table);
            vertical-align: middle;
            color: var(--text-secondary);
            font-size: 0.9rem;
            word-break: break-word;
            hyphens: auto;
            transition: background-color 0.2s ease, color 0.3s ease, border-color 0.3s ease;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background-color: var(--cell-hover);
        }

        .site-cell {
            font-weight: 600;
            color: var(--text-primary);
        }

        .username-cell {
            font-family: 'JetBrains Mono', 'SF Mono', monospace;
            font-size: 0.85rem;
        }

        .password-cell {
            font-family: 'JetBrains Mono', 'SF Mono', monospace;
            font-size: 0.85rem;
            word-break: break-all;
        }

        .action-cell {
            white-space: nowrap;
            width: 85px;
        }

        .icon-btn {
            background: transparent;
            border: none;
            width: 34px;
            height: 34px;
            border-radius: 8px;
            color: var(--icon-color);
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s, color 0.2s;
            margin-right: 2px;
        }

        .icon-btn:hover {
            background: var(--icon-hover-bg);
        }

        .icon-btn.delete-btn:hover {
            background: #ffebee;
            color: #b71c1c;
        }

        .empty-row td {
            padding: 40px 12px;
            text-align: center;
            color: #7c8ba0;
            font-size: 1rem;
            background: var(--bg-vault);
        }

        #toast {
            visibility: hidden;
            min-width: 180px;
            background-color: var(--toast-bg);
            color: var(--toast-text);
            text-align: center;
            border-radius: 60px;
            padding: 12px 20px;
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 500;
            box-shadow: 0 12px 28px rgba(0,20,40,0.3);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            transition: visibility 0.2s, opacity 0.2s, background-color 0.3s ease;
            opacity: 0;
            font-size: 0.95rem;
            pointer-events: none;
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
        }

        .file-input {
            display: none;
        }

        footer {
            margin-top: 22px;
            display: flex;
            justify-content: flex-end;
            color: #8a9bb0;
            font-size: 0.8rem;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* ç§»åŠ¨ç«¯ç»†è°ƒ */
        @media (max-width: 700px) {
            .search-wrapper {
                max-width: 100%;
            }
        }

        @media (max-width: 550px) {
            body { padding: 6px; }
            .password-vault { padding: 14px; }
            h1 { font-size: 1.5rem; }
            .btn-add { padding: 8px 14px; font-size: 0.85rem; }
            .add-panel { flex-direction: column; align-items: stretch; }
            .input-field { width: 100%; }
            .password-row { flex-wrap: wrap; }
            .btn-generate { width: 100%; height: 46px; border-radius: 16px; }
            .btn-primary { width: 100%; justify-content: center; padding: 14px; }
            .toolbar { flex-direction: column; align-items: stretch; }
            .search-wrapper { max-width: 100%; height: 40px; }
            .action-buttons { justify-content: space-between; }
            .btn-outline { flex: 1; justify-content: center; font-size: 0.8rem; padding: 8px 8px; }
            th, td { padding: 8px 5px; font-size: 0.8rem; }
            .icon-btn { width: 36px; height: 36px; }
            .dropdown-menu { width: 160px; }
        }

        @media (max-width: 380px) {
            th, td { padding: 6px 4px; }
            .icon-btn { width: 32px; height: 32px; font-size: 0.9rem; }
            .action-cell { width: 70px; }
        }
    </style>
</head>
<body>
    <div class="password-vault">
        <h1>
            <i class="fas fa-key"></i> å¯†ç æ¸…å•
            <div class="header-actions">
                <!-- èœå•æŒ‰é’®åŠä¸‹æ‹‰èœå• -->
                <div class="menu-container">
                    <button class="menu-btn" id="menuBtn"><i class="fas fa-bars"></i></button>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <div class="dropdown-item" id="darkModeItem">
                            <i class="fas fa-moon"></i> æš—é»‘æ¨¡å¼
                        </div>
                        <div class="dropdown-item" id="helpItem">
                            <i class="fas fa-question-circle"></i> ç½‘ç«™è¯´æ˜
                        </div>
                    </div>
                </div>
                <!-- æ·»åŠ /å–æ¶ˆæŒ‰é’® -->
                <button class="btn-add" id="toggleAddPanelBtn"><i class="fas fa-plus-circle"></i> æ·»åŠ å¯†ç </button>
            </div>
        </h1>

        <!-- æ·»åŠ é¢æ¿ï¼ˆé»˜è®¤éšè—ï¼‰ -->
        <div class="add-panel hidden" id="addPanel">
            <div class="input-field">
                <label><i class="fas fa-globe"></i> ç½‘ç«™</label>
                <input type="text" id="siteInput" placeholder="example.com" autocomplete="off">
            </div>
            <div class="input-field">
                <label><i class="fas fa-user"></i> ç”¨æˆ·å</label>
                <input type="text" id="usernameInput" placeholder="user@mail.com" autocomplete="off">
            </div>
            <!-- å¯†ç è¡Œï¼šè¾“å…¥æ¡† + éšæœºç”ŸæˆæŒ‰é’® -->
            <div class="password-row">
                <div class="input-field">
                    <label><i class="fas fa-lock"></i> å¯†ç </label>
                    <input type="text" id="passwordInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="off">
                </div>
                <button class="btn-generate" id="generatePasswordBtn" title="ç”Ÿæˆéšæœºå¯†ç "><i class="fas fa-dice"></i></button>
            </div>
            <button class="btn-primary" id="addBtn"><i class="fas fa-plus-circle"></i> ä¿å­˜æ–°å¯†ç </button>
        </div>

        <!-- å·¥å…·æ ï¼šæœç´¢ + å¯¼å…¥å¯¼å‡º + ç»Ÿè®¡ -->
        <div class="toolbar">
            <div class="search-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="æœç´¢ç½‘ç«™æˆ–ç”¨æˆ·å..." autocomplete="off">
                <button class="clear-search" id="clearSearchBtn" title="æ¸…ç©ºæœç´¢"><i class="fas fa-times-circle"></i></button>
            </div>
            <div class="action-buttons">
                <span class="stats-badge" id="statsCounter"><i class="far fa-clipboard"></i> 0 é¡¹</span>
                <button class="btn-outline" id="exportBtn"><i class="fas fa-download"></i> ä¸‹è½½å¤‡ä»½</button>
                <button class="btn-outline" id="importBtn"><i class="fas fa-upload"></i> å¯¼å…¥å¤‡ä»½</button>
                <input type="file" id="fileInput" class="file-input" accept=".json,application/json">
            </div>
        </div>

        <!-- å¯†ç æ¸…å•è¡¨æ ¼ -->
        <div class="table-responsive">
            <table id="passwordTable">
                <thead>
                    <tr>
                        <th>ç½‘ç«™</th>
                        <th>ç”¨æˆ·å</th>
                        <th>å¯†ç åŸæ–‡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- åŠ¨æ€æ¸²æŸ“ -->
                </tbody>
            </table>
        </div>
        <footer>
            <i class="far fa-copy"></i> ç‚¹å‡»å›¾æ ‡å¤åˆ¶å¯†ç  Â· <i class="far fa-trash-alt"></i> åˆ é™¤å³æ°¸ä¹…ç§»é™¤
        </footer>
    </div>

    <!-- å…¨å±€æç¤ºæµ®å±‚ -->
    <div id="toast"><i class="fas fa-check-circle"></i> <span id="toastMessage">å¤åˆ¶æˆåŠŸ</span></div>

    <script>
        (function() {
            // ---------- æ ¸å¿ƒæ•°æ® ----------
            let entries = [];
            let searchTerm = '';

            // DOM å…ƒç´ 
            const siteInput = document.getElementById('siteInput');
            const usernameInput = document.getElementById('usernameInput');
            const passwordInput = document.getElementById('passwordInput');
            const generatePasswordBtn = document.getElementById('generatePasswordBtn');
            const addBtn = document.getElementById('addBtn');
            const toggleAddPanelBtn = document.getElementById('toggleAddPanelBtn');
            const addPanel = document.getElementById('addPanel');
            const searchInput = document.getElementById('searchInput');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            const tableBody = document.getElementById('tableBody');
            const statsCounter = document.getElementById('statsCounter');
            const exportBtn = document.getElementById('exportBtn');
            const importBtn = document.getElementById('importBtn');
            const fileInput = document.getElementById('fileInput');
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            // èœå•ç›¸å…³
            const menuBtn = document.getElementById('menuBtn');
            const dropdownMenu = document.getElementById('dropdownMenu');
            const darkModeItem = document.getElementById('darkModeItem');
            const helpItem = document.getElementById('helpItem');

            // æš—é»‘æ¨¡å¼çŠ¶æ€
            let darkMode = false;

            // ---------- å·¥å…·å‡½æ•° ----------
            function showToast(text, icon = 'âœ…') {
                toastMessage.innerText = text;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 2000);
            }

            function escapeHtml(unsafe) {
                if (unsafe === undefined || unsafe === null) return '';
                return String(unsafe)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }

            function generateId() {
                return Date.now() + '-' + Math.random().toString(36).substring(2, 10);
            }

            // ç”Ÿæˆéšæœºå¯†ç ï¼ˆ12-16ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šç¬¦å· @ . / _ï¼‰
            function generateRandomPassword() {
                const length = Math.floor(Math.random() * 5) + 12; // 12-16
                // å­—ç¬¦é›†ï¼šå¤§å°å†™å­—æ¯ + æ•°å­— + å…è®¸çš„ç‰¹æ®Šç¬¦å· @ . / _
                const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@./_';
                let password = '';
                for (let i = 0; i < length; i++) {
                    const randomIndex = Math.floor(Math.random() * charset.length);
                    password += charset[randomIndex];
                }
                return password;
            }

            // åŠ è½½ localStorage æ•°æ®
            function loadFromStorage() {
                try {
                    const stored = localStorage.getItem('passwordVault');
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        if (Array.isArray(parsed)) {
                            entries = parsed
                                .filter(item => item && typeof item === 'object')
                                .map(item => ({
                                    id: item.id || generateId(),
                                    site: item.site ? String(item.site) : '',
                                    username: item.username ? String(item.username) : '',
                                    password: item.password ? String(item.password) : ''
                                }));
                        } else {
                            entries = [];
                        }
                    } else {
                        // ç¤ºä¾‹æ•°æ®
                        entries = [
                            { id: generateId(), site: '91.com', username: 'wode', password: 'taopaoba666' },
                            { id: generateId(), site: '123', username: '123333', password: 'xjdjddj' },
                            { id: generateId(), site: 'jdjdjd', username: 'dhhsh', password: 'udud' },
                        ];
                    }
                } catch (e) {
                    entries = [];
                    showToast('è¯»å–å­˜å‚¨å¤±è´¥ï¼Œå·²é‡ç½®', 'âš ï¸');
                }
                saveToStorage();
            }

            // åŠ è½½æš—é»‘æ¨¡å¼åå¥½
            function loadDarkModePreference() {
                try {
                    const savedDarkMode = localStorage.getItem('darkMode');
                    if (savedDarkMode === 'true') {
                        document.body.classList.add('dark-mode');
                        darkMode = true;
                    } else {
                        document.body.classList.remove('dark-mode');
                        darkMode = false;
                    }
                } catch (e) {
                    // å¿½ç•¥é”™è¯¯
                }
            }

            function saveToStorage() {
                localStorage.setItem('passwordVault', JSON.stringify(entries));
            }

            function getFilteredEntries() {
                if (!searchTerm.trim()) return entries;
                const lowerTerm = searchTerm.trim().toLowerCase();
                return entries.filter(entry => 
                    entry.site.toLowerCase().includes(lowerTerm) || 
                    entry.username.toLowerCase().includes(lowerTerm)
                );
            }

            function renderTable() {
                const filtered = getFilteredEntries();
                const totalCount = entries.length;
                const filteredCount = filtered.length;

                statsCounter.innerHTML = `<i class="far fa-clipboard"></i> ${filteredCount} / ${totalCount} é¡¹`;

                if (filtered.length === 0) {
                    tableBody.innerHTML = `
                        <tr class="empty-row">
                            <td colspan="4">
                                <i class="fas fa-box-open" style="font-size: 2rem; opacity: 0.5; margin-bottom: 8px; display: block;"></i>
                                ${entries.length === 0 ? 'è¿˜æ²¡æœ‰å¯†ç ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ ' : 'æ²¡æœ‰åŒ¹é…çš„å¯†ç '}
                            </td>
                        </tr>
                    `;
                    return;
                }

                let html = '';
                filtered.forEach(entry => {
                    html += `
                        <tr data-id="${escapeHtml(entry.id)}">
                            <td class="site-cell"><i class="fas fa-link" style="color: #4a6a8a; width: 20px;"></i> ${escapeHtml(entry.site)}</td>
                            <td class="username-cell">${escapeHtml(entry.username)}</td>
                            <td class="password-cell">${escapeHtml(entry.password)}</td>
                            <td class="action-cell">
                                <button class="icon-btn copy-btn" title="å¤åˆ¶å¯†ç "><i class="far fa-copy"></i></button>
                                <button class="icon-btn delete-btn" title="åˆ é™¤æ¡ç›®"><i class="far fa-trash-alt"></i></button>
                            </td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = html;
            }

            function refreshUI() {
                saveToStorage();
                renderTable();
            }

            // åˆ‡æ¢æ·»åŠ é¢æ¿æ˜¾ç¤º/éšè—ï¼Œå¹¶æ›´æ–°æŒ‰é’®æ–‡å­—
            function toggleAddPanel() {
                addPanel.classList.toggle('hidden');
                if (addPanel.classList.contains('hidden')) {
                    toggleAddPanelBtn.innerHTML = '<i class="fas fa-plus-circle"></i> æ·»åŠ å¯†ç ';
                } else {
                    toggleAddPanelBtn.innerHTML = '<i class="fas fa-times-circle"></i> å–æ¶ˆæ·»åŠ ';
                    siteInput.focus();
                }
            }

            function hideAddPanel() {
                addPanel.classList.add('hidden');
                toggleAddPanelBtn.innerHTML = '<i class="fas fa-plus-circle"></i> æ·»åŠ å¯†ç ';
            }

            // åˆ‡æ¢æš—é»‘æ¨¡å¼
            function toggleDarkMode() {
                document.body.classList.toggle('dark-mode');
                darkMode = !darkMode;
                // ä¿å­˜åå¥½åˆ° localStorage
                try {
                    localStorage.setItem('darkMode', darkMode);
                } catch (e) {}
                showToast(darkMode ? 'æš—é»‘æ¨¡å¼å·²å¼€å¯' : 'æµ…è‰²æ¨¡å¼å·²å¼€å¯', 'ğŸŒ“');
                dropdownMenu.classList.remove('show');
                menuBtn.classList.remove('open');
                menuBtn.innerHTML = '<i class="fas fa-bars"></i>';
            }

            // æ˜¾ç¤ºç½‘ç«™è¯´æ˜
            function showHelp() {
                alert('ğŸ” æœ¬åœ°å¯†ç æœ¬ä½¿ç”¨è¯´æ˜ï¼š\n\nâ€¢ æ‰€æœ‰å¯†ç ä»…ä¿å­˜åœ¨ä½ çš„æµè§ˆå™¨æœ¬åœ°ï¼Œä¸ä¼šä¸Šä¼ ã€‚\nâ€¢ ç‚¹å‡»å¤åˆ¶æŒ‰é’®å¯å¤åˆ¶å¯†ç åŸæ–‡ã€‚\nâ€¢ åˆ é™¤æ¡ç›®åæ— æ³•æ¢å¤ã€‚\nâ€¢ å¯é€šè¿‡â€œä¸‹è½½å¤‡ä»½â€ä¿å­˜æ•°æ®ä¸ºJSONæ–‡ä»¶ã€‚\nâ€¢ å¯¼å…¥å¤‡ä»½ä¼šæ›¿æ¢å½“å‰æ‰€æœ‰å¯†ç ã€‚');
                dropdownMenu.classList.remove('show');
                menuBtn.classList.remove('open');
                menuBtn.innerHTML = '<i class="fas fa-bars"></i>';
            }

            // ç‚¹å‡»èœå•æŒ‰é’®åˆ‡æ¢ä¸‹æ‹‰èœå•å’Œå›¾æ ‡
            function toggleDropdown(e) {
                e.stopPropagation();
                dropdownMenu.classList.toggle('show');
                menuBtn.classList.toggle('open');
                if (menuBtn.classList.contains('open')) {
                    menuBtn.innerHTML = '<i class="fas fa-times"></i>';
                } else {
                    menuBtn.innerHTML = '<i class="fas fa-bars"></i>';
                }
            }

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
            document.addEventListener('click', function(event) {
                if (!menuBtn.contains(event.target) && !dropdownMenu.contains(event.target)) {
                    dropdownMenu.classList.remove('show');
                    menuBtn.classList.remove('open');
                    menuBtn.innerHTML = '<i class="fas fa-bars"></i>';
                }
            });

            // ---------- æµè§ˆå™¨åé€€æ‹¦æˆª ----------
            // åˆå§‹åŒ–æ—¶æ·»åŠ ä¸€ä¸ªå†å²çŠ¶æ€ï¼Œä»¥ä¾¿ç›‘å¬åé€€
            (function initBackIntercept() {
                // å‘å†å²æ ˆä¸­æ·»åŠ ä¸€ä¸ªçŠ¶æ€ï¼Œè¿™æ ·å½“ç”¨æˆ·åé€€æ—¶ä¼šè§¦å‘popstate
                history.pushState({ page: 'password-vault' }, null, location.href);
                
                window.addEventListener('popstate', function(event) {
                    // å¼¹å‡ºç¡®è®¤æ¡†
                    const confirmLeave = confirm('æ˜¯å¦ç¡®è®¤é€€å‡ºï¼Ÿ');
                    if (confirmLeave) {
                        // ç”¨æˆ·ç¡®è®¤ç¦»å¼€ï¼Œè®©æµè§ˆå™¨ç»§ç»­åé€€ï¼ˆä¸åšä»»ä½•æ“ä½œï¼‰
                        // æ³¨æ„ï¼šæ­¤æ—¶å·²ç»è§¦å‘äº†popstateï¼Œå¦‚æœä¸åšå¤„ç†ï¼Œæµè§ˆå™¨ä¼šå›åˆ°ä¸Šä¸€ä¸ªé¡µé¢
                        // ä½†å› ä¸ºæˆ‘ä»¬ä¹‹å‰pushäº†ä¸€ä¸ªçŠ¶æ€ï¼Œæ‰€ä»¥é»˜è®¤ä¼šå›åˆ°pushå‰çš„çŠ¶æ€ï¼Œå³ä¸Šä¸€é¡µ
                        // è¿™é‡Œä¸éœ€è¦é¢å¤–ä»£ç 
                    } else {
                        // ç”¨æˆ·å–æ¶ˆï¼Œéœ€è¦æŠµæ¶ˆè¿™æ¬¡åé€€ï¼Œé‡æ–°pushä¸€ä¸ªçŠ¶æ€
                        history.pushState({ page: 'password-vault' }, null, location.href);
                        // å¯é€‰æç¤º
                        showToast('å·²å–æ¶ˆåé€€', 'ğŸ”™');
                    }
                });
            })();

            // ---------- äº‹ä»¶ç»‘å®š ----------
            menuBtn.addEventListener('click', toggleDropdown);
            darkModeItem.addEventListener('click', toggleDarkMode);
            helpItem.addEventListener('click', showHelp);

            toggleAddPanelBtn.addEventListener('click', toggleAddPanel);

            // ç”Ÿæˆéšæœºå¯†ç 
            generatePasswordBtn.addEventListener('click', function() {
                const newPassword = generateRandomPassword();
                passwordInput.value = newPassword;
                showToast('éšæœºå¯†ç å·²ç”Ÿæˆ', 'ğŸ²');
            });

            addBtn.addEventListener('click', function() {
                const site = siteInput.value.trim();
                const username = usernameInput.value.trim();
                const password = passwordInput.value.trim();

                if (!site || !username || !password) {
                    showToast('è¯·å¡«å†™ç½‘ç«™ã€ç”¨æˆ·åå’Œå¯†ç ', 'âš ï¸');
                    return;
                }

                const newEntry = {
                    id: generateId(),
                    site: site,
                    username: username,
                    password: password
                };
                entries.push(newEntry);
                refreshUI();

                siteInput.value = '';
                usernameInput.value = '';
                passwordInput.value = '';
                hideAddPanel();

                showToast('å¯†ç å·²æ·»åŠ ', 'ğŸ”');
            });

            [siteInput, usernameInput, passwordInput].forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addBtn.click();
                    }
                });
            });

            searchInput.addEventListener('input', (e) => {
                searchTerm = e.target.value;
                renderTable();
            });

            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                searchTerm = '';
                renderTable();
            });

            exportBtn.addEventListener('click', function() {
                if (entries.length === 0) {
                    showToast('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º', 'ğŸ“');
                    return;
                }
                const dataStr = JSON.stringify(entries, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `å¯†ç æœ¬å¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 200);
                showToast('å¤‡ä»½ä¸‹è½½å·²å¯åŠ¨', 'ğŸ’¾');
            });

            importBtn.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        const imported = JSON.parse(content);
                        if (!Array.isArray(imported)) {
                            showToast('æ— æ•ˆçš„å¤‡ä»½æ ¼å¼ï¼šé¡»ä¸ºæ•°ç»„', 'âŒ');
                            return;
                        }

                        const newEntries = imported
                            .filter(item => item && typeof item === 'object')
                            .map(item => ({
                                id: generateId(),
                                site: item.site ? String(item.site) : '',
                                username: item.username ? String(item.username) : '',
                                password: item.password ? String(item.password) : ''
                            }))
                            .filter(item => item.site !== '' || item.username !== '' || item.password !== '');

                        if (newEntries.length === 0) {
                            showToast('æœªå‘ç°æœ‰æ•ˆæ¡ç›®', 'ğŸ“‚');
                            return;
                        }

                        entries = newEntries;
                        refreshUI();
                        showToast(`æˆåŠŸå¯¼å…¥ ${newEntries.length} æ¡å¯†ç `, 'ğŸ“¥');
                    } catch (err) {
                        showToast('è§£æå¤±è´¥ï¼Œä¸æ˜¯æœ‰æ•ˆçš„JSON', 'âš ï¸');
                    } finally {
                        fileInput.value = '';
                    }
                };
                reader.readAsText(file);
            });

            tableBody.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                const row = target.closest('tr');
                if (!row || !row.dataset.id) return;
                const entryId = row.dataset.id;

                if (target.classList.contains('copy-btn')) {
                    const entry = entries.find(e => e.id === entryId);
                    if (!entry) return;
                    navigator.clipboard.writeText(entry.password).then(() => {
                        showToast(`å¯†ç å·²å¤åˆ¶: ${entry.site}`, 'ğŸ“‹');
                    }).catch(() => {
                        const textarea = document.createElement('textarea');
                        textarea.value = entry.password;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        showToast(`å¯†ç å·²å¤åˆ¶(å¤‡ç”¨)`, 'ğŸ“‹');
                    });
                } else if (target.classList.contains('delete-btn')) {
                    if (confirm('ç¡®å®šåˆ é™¤è¿™æ¡å¯†ç å—ï¼Ÿ')) {
                        const index = entries.findIndex(e => e.id === entryId);
                        if (index !== -1) {
                            entries.splice(index, 1);
                            refreshUI();
                            showToast('æ¡ç›®å·²åˆ é™¤', 'ğŸ—‘ï¸');
                        }
                    }
                }
            });

            // åˆå§‹åŒ–ï¼šå…ˆåŠ è½½æš—é»‘æ¨¡å¼åå¥½ï¼Œå†åŠ è½½æ•°æ®
            loadDarkModePreference();
            loadFromStorage();
            renderTable();
        })();
    </script>
</body>
</html>